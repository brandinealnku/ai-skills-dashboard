<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NKU - AI Skillsets for Hiring (Executive Dashboard)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f8fafc; --surface:#ffffff; --text:#0f172a;
      --muted:#475569; --muted-2:#64748b; --border:#dbe3ef;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      --accent:#2563eb; --accent-2:#1d4ed8;
      --radius:18px; --radius-sm:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;}
    header{position:sticky;top:0;z-index:50;background:rgba(248,250,252,.78);backdrop-filter:blur(10px);border-bottom:1px solid rgba(219,227,239,.7);}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .badge{font-size:12px;color:#0b1220;background:rgba(37,99,235,.10);border:1px solid rgba(37,99,235,.18);padding:6px 10px;border-radius:999px;display:inline-flex;gap:8px;align-items:center;}
    .dot{width:6px;height:6px;border-radius:999px;background:var(--accent);display:inline-block}
    .title{margin:0;font-size:18px;letter-spacing:-.02em;}
    .subtitle{margin:2px 0 0;font-size:13px;color:var(--muted);}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pillset{background:var(--surface);border:1px solid var(--border);border-radius:999px;padding:6px;display:flex;gap:6px;align-items:center;box-shadow:0 6px 18px rgba(15,23,42,0.05);}
    .pillset button{border:0;background:transparent;cursor:pointer;padding:8px 10px;border-radius:999px;color:var(--muted);font-weight:600;font-size:13px;}
    .pillset button[aria-pressed="true"]{background:rgba(37,99,235,.12);color:var(--accent-2);}
    .meta{font-size:12px;color:var(--muted-2);display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;border:1px solid rgba(219,227,239,.9);background:rgba(2,6,23,.02);font-weight:700;white-space:nowrap;}
    .sources-btn{border:1px solid var(--border);background:var(--surface);border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:700;font-size:13px;color:var(--muted);}

    main{padding:20px 0 34px}
    .grid{display:grid;gap:14px;}
    .grid.kpis{grid-template-columns:repeat(12,1fr)}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .card .hd{padding:14px 16px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;border-bottom:1px solid rgba(219,227,239,.65);}
    .card .hd h2{margin:0;font-size:14px;letter-spacing:-.01em;}
    .card .hd p{margin:4px 0 0;font-size:12px;color:var(--muted);}
    .card .bd{padding:14px 16px}

    .kpi{padding:14px 14px 12px;display:flex;flex-direction:column;gap:8px;min-height:120px;}
    .kpi-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .kpi-label{font-size:12px;color:var(--muted);font-weight:650;}
    .kpi-value{font-size:26px;letter-spacing:-.03em;font-weight:750;margin-top:2px;}
    .kpi-delta{font-size:12px;font-weight:700;display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid rgba(219,227,239,.9);background:rgba(2,6,23,.02);color:var(--muted);white-space:nowrap;}
    .spark{width:100%;height:36px;border-radius:12px;background:linear-gradient(180deg,rgba(37,99,235,.10),rgba(37,99,235,.02));border:1px solid rgba(37,99,235,.18);overflow:hidden;}
    .spark svg{display:block;width:100%;height:100%}

    .kpi.span-3{grid-column:span 3}
    .span-12{grid-column:span 12}
    .span-7{grid-column:span 7}
    .span-5{grid-column:span 5}
    .span-6{grid-column:span 6}

    @media (max-width:980px){
      .kpi.span-3{grid-column:span 6}
      .span-7,.span-5,.span-6{grid-column:span 12}
    }
    @media (max-width:520px){
      .kpi.span-3{grid-column:span 12}
    }

    .lists{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:980px){.lists{grid-template-columns:1fr}}
    .rank{border:1px solid rgba(219,227,239,.75);border-radius:var(--radius-sm);overflow:hidden;}
    .rank .rh{padding:12px 12px 10px;background:rgba(2,6,23,.02);border-bottom:1px solid rgba(219,227,239,.75);}
    .rank .rh strong{font-size:13px}
    .rank .rh div{margin-top:4px;font-size:12px;color:var(--muted)}
    .rank ul{margin:0;padding:0;list-style:none;}
    .rank li{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(219,227,239,.55);}
    .rank li:last-child{border-bottom:0}
    .rank .left{display:flex;gap:10px;align-items:flex-start;min-width:0;}
    .rank .num{width:24px;height:24px;border-radius:8px;display:grid;place-items:center;background:rgba(37,99,235,.10);border:1px solid rgba(37,99,235,.18);color:var(--accent-2);font-weight:800;font-size:12px;flex:0 0 auto;}
    .rank .skill{font-weight:750;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px;}
    .rank .fam{font-size:12px;color:var(--muted);margin-top:2px}
    .rank .right{text-align:right;flex:0 0 auto;}
    .rank .metric{font-weight:800;font-size:13px;}
    .rank .note{font-size:12px;color:var(--muted);margin-top:2px}

    .heat-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:920px;}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(219,227,239,.7);font-size:12px;vertical-align:middle;background:var(--surface);}
    th{position:sticky;top:0;z-index:2;background:#f9fbff;color:#0b1220;font-size:12px;font-weight:800;border-bottom:1px solid rgba(219,227,239,.95);text-align:left;white-space:nowrap;}
    td:first-child,th:first-child{position:sticky;left:0;z-index:1;background:#fff;}
    .cell{border-radius:12px;border:1px solid rgba(219,227,239,.85);padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px;user-select:none;min-width:140px;}
    .lvl{font-weight:850;font-size:12px;}
    .lvl0{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.22)}
    .lvl1{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.24)}
    .lvl2{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.22)}
    .lvl3{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.22)}
    .muted{color:var(--muted)}
    .chart-box{height:260px}

    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    @media (max-width:980px){.actions{grid-template-columns:1fr}}
    .action{border:1px solid rgba(219,227,239,.75);border-radius:var(--radius-sm);padding:12px;background:rgba(2,6,23,.015);}
    .action .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(219,227,239,.85);background:#fff;font-size:12px;font-weight:800;color:var(--muted);margin-bottom:8px;}
    .action h4{margin:0 0 6px;font-size:13px}
    .action p{margin:0;font-size:12px;color:var(--muted)}

    .debug{
      margin-top:14px;
      border:1px dashed rgba(37,99,235,.35);
      background: rgba(37,99,235,.05);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .debug strong{color:#0b1220}
    .debug button{
      border:1px solid rgba(37,99,235,.25);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:#0b1220;
    }
    .debug pre{
      margin:8px 0 0;
      padding:10px;
      background:#fff;
      border:1px solid rgba(219,227,239,.9);
      border-radius:12px;
      overflow:auto;
      max-width:100%;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div>
          <div class="badge"><span class="dot"></span><strong>Executive Dashboard - Presented at AI Panel Discussion</strong> · AI Skillsets for Hiring Now</div>
          <h1 class="title">NKU — AI Skillset Needs for Graduates Getting Hired Today</h1>
          <p class="subtitle">Top skills now · fastest-rising skills · NKU coverage gaps · opportunities board</p>
        </div>

        <div class="toolbar">
          <div class="pillset" role="group" aria-label="Audience Toggle" id="audienceToggle">
            <button type="button" data-audience="all" aria-pressed="true">All NKU Grads</button>
            <button type="button" data-audience="business" aria-pressed="false">Business</button>
            <button type="button" data-audience="informatics" aria-pressed="false">Informatics</button>
            <button type="button" data-audience="health" aria-pressed="false">Health</button>
          </div>
          <div class="meta">
            <span><span class="dot"></span> Last refresh: <strong id="lastRefresh">—</strong></span>
            <span><strong>Sources:</strong> USAJOBS + Adzuna (via Cloudflare Worker)</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="wrap">

      <div class="debug">
        <div>
          <div><strong>Debug</strong>: USAJOBS uses full fan-out. Adzuna uses reduced terms + no query= fallback (avoids HTML + 429).</div>
          <div>AI jobs: <strong id="dbgAi">—</strong> · Baseline jobs: <strong id="dbgBase">—</strong></div>
          <pre id="dbgSample">Loading…</pre>
        </div>
        <div>
          <button id="forceRefresh">Force refresh (clear cache)</button>
        </div>
      </div>

      <section class="grid kpis" aria-label="Key performance indicators" style="margin-top:14px">
        <div class="card kpi span-3">
          <div class="kpi-top">
            <div>
              <div class="kpi-label">AI-skill job share</div>
              <div class="kpi-value" id="kpi-aiShare">—</div>
            </div>
            <div class="kpi-delta" id="kpi-aiShareDelta">live</div>
          </div>
          <div class="muted" style="font-size:12px">AI postings ÷ (AI + baseline postings)</div>
          <div class="spark"><svg viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline id="spark-aiShare" fill="none" stroke="rgba(37,99,235,.8)" stroke-width="2" points=""></polyline>
          </svg></div>
        </div>

        <div class="card kpi span-3">
          <div class="kpi-top">
            <div>
              <div class="kpi-label">Fastest-growing skill family</div>
              <div class="kpi-value" id="kpi-fastFamily">—</div>
            </div>
            <div class="kpi-delta" id="kpi-fastFamilyDelta">live</div>
          </div>
          <div class="muted" style="font-size:12px">Heuristic from postings text</div>
          <div class="spark"><svg viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline id="spark-fastFamily" fill="none" stroke="rgba(37,99,235,.8)" stroke-width="2" points=""></polyline>
          </svg></div>
        </div>

        <div class="card kpi span-3">
          <div class="kpi-top">
            <div>
              <div class="kpi-label">Non-CS share of AI demand</div>
              <div class="kpi-value" id="kpi-noncsShare">—</div>
            </div>
            <div class="kpi-delta" id="kpi-noncsDelta">live</div>
          </div>
          <div class="muted" style="font-size:12px">Heuristic from job titles</div>
          <div class="spark"><svg viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline id="spark-noncs" fill="none" stroke="rgba(37,99,235,.8)" stroke-width="2" points=""></polyline>
          </svg></div>
        </div>

        <div class="card kpi span-3">
          <div class="kpi-top">
            <div>
              <div class="kpi-label">Estimated wage premium</div>
              <div class="kpi-value" id="kpi-wagePremium">—</div>
            </div>
            <div class="kpi-delta" id="kpi-wageDelta">n/a</div>
          </div>
          <div class="muted" style="font-size:12px">Not exposed by these APIs</div>
          <div class="spark"><svg viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline id="spark-wage" fill="none" stroke="rgba(37,99,235,.8)" stroke-width="2" points=""></polyline>
          </svg></div>
        </div>
      </section>

      <section class="grid" style="margin-top:14px">
        <div class="card span-12">
          <div class="hd">
            <div>
              <h2>Top Skills Now vs. Fastest Rising</h2>
              <p>Automatically extracted from USAJOBS + Adzuna posting text (titles/descriptions).</p>
            </div>
            <div class="meta"><span class="chip">Now: <strong>Current sample</strong> · Rising: <strong>Heuristic</strong></span></div>
          </div>
          <div class="bd">
            <div class="lists">
              <div class="rank">
                <div class="rh"><strong>Top AI Skills in Postings</strong><div>Ranked by frequency in fetched postings</div></div>
                <ul id="listNow"></ul>
              </div>
              <div class="rank">
                <div class="rh"><strong>Fastest Rising Skills</strong><div>Heuristic (recent vs older slice)</div></div>
                <ul id="listRising"></ul>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="grid" style="margin-top:14px">
        <div class="card span-5">
          <div class="hd">
            <div>
              <h2>Where the Jobs Are</h2>
              <p>Top categories from blended AI postings.</p>
            </div>
            <div class="meta"><span class="chip" id="segLabel">Top categories</span></div>
          </div>
          <div class="bd">
            <div class="chart-box"><canvas id="segChart"></canvas></div>
            <p class="muted" id="segSourceNote" style="margin:10px 0 0; font-size:12px">Sources: USAJOBS + Adzuna</p>
          </div>
        </div>
      </section>

    </div>
  </main>

  <script>
    const PROXY_BASE = "https://ai-skills-proxy.nealb3.workers.dev";

    // USAJOBS gets the full fan-out
    const AI_TERMS_US = [
      "artificial intelligence","machine learning","generative ai","genai","llm",
      "large language model","chatgpt","copilot"
    ];

    // Adzuna gets a smaller set to avoid 429 (you can expand later)
    const AI_TERMS_ADZUNA = [
      "artificial intelligence","machine learning","llm","generative ai"
    ];

    const BASELINE_TERMS = ["software","analyst","manager"];

    const CACHE_KEY = "nku_ai_jobs_blend_cache_v4";
    const CACHE_TTL_MS = 60 * 60 * 1000;

    const $ = (sel, root=document) => root.querySelector(sel);
    function setText(sel, txt){ const el = $(sel); if(el) el.textContent = txt; }

    function readCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(Date.now() - obj.time > CACHE_TTL_MS) return null;
        return obj.data;
      }catch{ return null; }
    }
    function writeCache(data){
      try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), data })); }catch{}
    }
    function clearCache(){ try{ localStorage.removeItem(CACHE_KEY); }catch{} }

    async function fetchJson(url){
      const res = await fetch(url, { cache:"no-store" });
      const text = await res.text();
      let json;
      try{ json = JSON.parse(text); }catch{
        throw new Error("Non-JSON from " + url + ": " + text.slice(0,180));
      }
      if(!res.ok){
        const msg = json?.error || json?.message || ("HTTP " + res.status);
        throw new Error(url + " → " + msg);
      }
      return json;
    }

    async function fetchUSAJOBS(term, perPage=25, page=1){
      const t = encodeURIComponent(term);
      const url = `${PROXY_BASE}/usajobs?keyword=${t}&ResultsPerPage=${perPage}&Page=${page}`;
      return { url, json: await fetchJson(url) };
    }

    // IMPORTANT FIX: Adzuna uses what= only (no query= fallback)
    async function fetchAdzuna(term, perPage=25, page=1){
      const t = encodeURIComponent(term);
      const url = `${PROXY_BASE}/adzuna?what=${t}&results_per_page=${perPage}&page=${page}&country=us`;
      return { url, json: await fetchJson(url) };
    }

    function normalizeUSAJOBS(payload){
      const items = payload?.SearchResult?.SearchResultItems || [];
      return items.map(it=>{
        const d = it?.MatchedObjectDescriptor || {};
        const details = d?.UserArea?.Details || {};
        const cats = (d?.JobCategory || []).map(c=>c?.Name).filter(Boolean);
        return {
          source: "USAJOBS",
          title: d?.PositionTitle || "",
          description: details?.MajorDuties || details?.JobSummary || "",
          company: d?.OrganizationName || d?.DepartmentName || "Federal",
          category: cats[0] || d?.DepartmentName || "Federal",
          location: (d?.PositionLocation || [])[0]?.LocationName || "",
          url: d?.PositionURI || ""
        };
      });
    }

    function normalizeAdzuna(payload){
      const items = payload?.results || [];
      return items.map(it=>({
        source: "Adzuna",
        title: it?.title || "",
        description: it?.description || "",
        company: it?.company?.display_name || "Unknown",
        category: it?.category?.label || "Other",
        location: it?.location?.display_name || "",
        url: it?.redirect_url || it?.adref || ""
      }));
    }

    function dedupeJobs(jobs){
      const seen = new Set();
      const out = [];
      for(const j of jobs){
        const key = (j.url || `${j.source}|${j.company}|${j.title}|${j.location}`).toLowerCase().trim();
        if(seen.has(key)) continue;
        seen.add(key);
        out.push(j);
      }
      return out;
    }

    async function fanoutFetch(terms, fetcher, normalizer){
      const results = [];
      const debug = [];
      const settled = await Promise.allSettled(terms.map(t => fetcher(t)));
      for(let i=0;i<settled.length;i++){
        const term = terms[i];
        const r = settled[i];
        if(r.status === "fulfilled"){
          const { url, json } = r.value;
          debug.push({ term, ok:true, url });
          results.push(...normalizer(json));
        } else {
          debug.push({ term, ok:false, error:String(r.reason).slice(0,160) });
        }
      }
      return { jobs: dedupeJobs(results), debug };
    }

    function pct(n){ return (n*100).toFixed(1) + "%"; }

    const SKILLS = [
      { skill:"Prompting & workflow design", family:"GenAI workflows", keys:["prompt","prompting","workflow","automation","agent","agentic"] },
      { skill:"AI tool proficiency (Copilot/ChatGPT)", family:"GenAI tools", keys:["copilot","chatgpt","assistant"] },
      { skill:"LLM application development", family:"GenAI engineering", keys:["llm","langchain","rag","retrieval","vector","embedding","prompt engineering"] },
      { skill:"Python for automation", family:"Automation", keys:["python","scripting","automation","etl"] },
      { skill:"Data literacy (SQL / dashboards)", family:"Data foundations", keys:["sql","power bi","tableau","dashboard","analytics","reporting"] },
      { skill:"Model evaluation & testing", family:"Governance", keys:["evaluation","red team","red-team","testing","benchmark","validation"] },
      { skill:"AI ethics & responsible use", family:"Governance", keys:["responsible ai","ethics","fairness","bias","governance","policy","compliance"] },
      { skill:"Security & privacy", family:"Trust", keys:["privacy","security","pii","risk","secure","infosec"] },
    ];

    function scoreSkills(jobs){
      const counts = new Map();
      for(const s of SKILLS) counts.set(s.skill, 0);
      for(const j of jobs){
        const text = (j.title + " " + j.description).toLowerCase();
        for(const s of SKILLS){
          if(s.keys.some(k => text.includes(k))) counts.set(s.skill, counts.get(s.skill) + 1);
        }
      }
      return counts;
    }

    function topFromCounts(countMap, jobsTotal, limit=8){
      return Array.from(countMap.entries())
        .map(([skill, c])=>{
          const meta = SKILLS.find(x=>x.skill===skill);
          return { skill, family: meta?.family || "Other", metric: String(c), note: `mentions (${jobsTotal} postings)` };
        })
        .sort((a,b)=> Number(b.metric)-Number(a.metric))
        .slice(0, limit);
    }

    function classifyNonCS(job){
      const t = (job.title || "").toLowerCase();
      const csWords = ["engineer","developer","data scientist","ml engineer","software","programmer","devops","architect","backend","frontend","full stack","full-stack"];
      return !csWords.some(w => t.includes(w));
    }

    function topCategories(jobs, limit=6){
      const m = new Map();
      for(const j of jobs){
        const key = (j.category || "Other").trim();
        m.set(key, (m.get(key)||0) + 1);
      }
      const arr = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0, limit);
      return { labels: arr.map(x=>x[0]), values: arr.map(x=>x[1]) };
    }

    let segChart = null;
    function renderSegmentation(labels, values){
      const ctx = document.getElementById("segChart");
      if(!window.Chart) return;
      if(segChart) segChart.destroy();
      segChart = new Chart(ctx, {
        type:"bar",
        data:{ labels, datasets:[{ label:"Top categories", data: values }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
        }
      });
    }

    function renderRankLists(now, rising){
      const liTemplate = (item, idx) => `
        <li>
          <div class="left">
            <div class="num">${idx+1}</div>
            <div style="min-width:0">
              <div class="skill">${item.skill}</div>
              <div class="fam">${item.family}</div>
            </div>
          </div>
          <div class="right">
            <div class="metric">${item.metric}</div>
            <div class="note">${item.note}</div>
          </div>
        </li>
      `;
      document.getElementById("listNow").innerHTML = now.map(liTemplate).join("");
      document.getElementById("listRising").innerHTML = rising.map(liTemplate).join("");
    }

    async function fetchBlended(){
      const cached = readCache();
      if(cached) return cached;

      const aiUS = await fanoutFetch(AI_TERMS_US, (t)=>fetchUSAJOBS(t), normalizeUSAJOBS);
      const aiAD = await fanoutFetch(AI_TERMS_ADZUNA, (t)=>fetchAdzuna(t), normalizeAdzuna);

      const baseUS = await fanoutFetch(BASELINE_TERMS, (t)=>fetchUSAJOBS(t), normalizeUSAJOBS);
      const baseAD = await fanoutFetch(BASELINE_TERMS, (t)=>fetchAdzuna(t), normalizeAdzuna);

      const aiJobs = dedupeJobs([...aiUS.jobs, ...aiAD.jobs]);
      const baseJobs = dedupeJobs([...baseUS.jobs, ...baseAD.jobs]);

      const out = {
        fetchedAt: new Date().toISOString(),
        counts: { ai: aiJobs.length, base: baseJobs.length },
        aiJobs, baseJobs,
        debug: { aiUS: aiUS.debug, aiAD: aiAD.debug, baseUS: baseUS.debug, baseAD: baseAD.debug }
      };
      writeCache(out);
      return out;
    }

    async function init(){
      document.getElementById("forceRefresh").addEventListener("click", ()=>{
        clearCache();
        location.reload();
      });

      try{
        const blended = await fetchBlended();

        setText("#lastRefresh", new Date(blended.fetchedAt).toLocaleString());
        setText("#dbgAi", String(blended.counts.ai));
        setText("#dbgBase", String(blended.counts.base));

        const debugView = {
          counts: blended.counts,
          aiUS_terms: blended.debug.aiUS,
          aiAD_terms: blended.debug.aiAD,
          aiSampleTitles: blended.aiJobs.slice(0,8).map(j=>`${j.source}: ${j.title}`),
          baseSampleTitles: blended.baseJobs.slice(0,5).map(j=>`${j.source}: ${j.title}`)
        };
        document.getElementById("dbgSample").textContent = JSON.stringify(debugView, null, 2);

        const share = blended.counts.ai / Math.max(blended.counts.ai + blended.counts.base, 1);
        const noncsShare = blended.aiJobs.length ? (blended.aiJobs.filter(classifyNonCS).length / blended.aiJobs.length) : 0;

        setText("#kpi-aiShare", pct(share));
        setText("#kpi-fastFamily", "—");
        setText("#kpi-noncsShare", pct(noncsShare));
        setText("#kpi-wagePremium", "—");

        const skillCounts = scoreSkills(blended.aiJobs);
        const topNow = topFromCounts(skillCounts, blended.aiJobs.length, 8);

        const mid = Math.floor(blended.aiJobs.length / 2) || 1;
        const recent = blended.aiJobs.slice(0, mid);
        const older = blended.aiJobs.slice(mid);

        const cRecent = scoreSkills(recent);
        const cOlder = scoreSkills(older);

        const rising = Array.from(cRecent.entries()).map(([skill, c1])=>{
          const c0 = cOlder.get(skill) || 0;
          const growth = c1 - c0;
          const meta = SKILLS.find(x=>x.skill===skill);
          return { skill, family: meta?.family || "Other", metric: (growth>=0?"+":"") + String(growth), note:"recent vs older slice" };
        }).sort((a,b)=> Number(b.metric)-Number(a.metric)).slice(0,8);

        setText("#kpi-fastFamily", rising[0]?.family || topNow[0]?.family || "—");

        renderRankLists(topNow, rising);

        const seg = topCategories(blended.aiJobs, 6);
        renderSegmentation(seg.labels, seg.values);
        setText("#segSourceNote", `Sources: USAJOBS + Adzuna via ${PROXY_BASE} (Adzuna reduced terms, cached 1h)`);

      }catch(err){
        console.error(err);
        document.getElementById("dbgSample").textContent = "Fetch failed:\n" + String(err);
      }
    }

    init();
  </script>
</body>
</html>
