<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NKU - AI Skillsets for Hiring (Executive Dashboard)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f8fafc; --surface:#ffffff; --text:#0f172a;
      --muted:#475569; --muted-2:#64748b; --border:#dbe3ef;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      --accent:#2563eb; --accent-2:#1d4ed8;
      --radius:18px; --radius-sm:14px;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;}
    header{position:sticky;top:0;z-index:50;background:rgba(248,250,252,.78);backdrop-filter:blur(10px);border-bottom:1px solid rgba(219,227,239,.7);}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .badge{font-size:12px;color:#0b1220;background:rgba(37,99,235,.10);border:1px solid rgba(37,99,235,.18);padding:6px 10px;border-radius:999px;display:inline-flex;gap:8px;align-items:center;}
    .dot{width:6px;height:6px;border-radius:999px;background:var(--accent);display:inline-block}
    .title{margin:0;font-size:18px;letter-spacing:-.02em;}
    .subtitle{margin:2px 0 0;font-size:13px;color:var(--muted);}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pillset{background:var(--surface);border:1px solid var(--border);border-radius:999px;padding:6px;display:flex;gap:6px;align-items:center;box-shadow:0 6px 18px rgba(15,23,42,0.05);}
    .pillset button{border:0;background:transparent;cursor:pointer;padding:8px 10px;border-radius:999px;color:var(--muted);font-weight:600;font-size:13px;}
    .pillset button[aria-pressed="true"]{background:rgba(37,99,235,.12);color:var(--accent-2);}
    .meta{font-size:12px;color:var(--muted-2);display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;border:1px solid rgba(219,227,239,.9);background:rgba(2,6,23,.02);font-weight:700;white-space:nowrap;}
    .sources-btn{border:1px solid var(--border);background:var(--surface);border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:700;font-size:13px;color:var(--muted);}
    main{padding:20px 0 34px}
    .grid{display:grid;gap:14px;}
    .grid.kpis{grid-template-columns:repeat(12,1fr)}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .card .hd{padding:14px 16px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;border-bottom:1px solid rgba(219,227,239,.65);}
    .card .hd h2{margin:0;font-size:14px;letter-spacing:-.01em;}
    .card .hd p{margin:4px 0 0;font-size:12px;color:var(--muted);}
    .card .bd{padding:14px 16px}

    .kpi{padding:14px 14px 12px;display:flex;flex-direction:column;gap:8px;min-height:120px;}
    .kpi-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .kpi-label{font-size:12px;color:var(--muted);font-weight:650;}
    .kpi-value{font-size:26px;letter-spacing:-.03em;font-weight:750;margin-top:2px;}
    .kpi-delta{font-size:12px;font-weight:700;display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid rgba(219,227,239,.9);background:rgba(2,6,23,.02);color:var(--muted);white-space:nowrap;}
    .kpi-delta.up{color:#0f6b2a;background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.20)}
    .spark{width:100%;height:36px;border-radius:12px;background:linear-gradient(180deg,rgba(37,99,235,.10),rgba(37,99,235,.02));border:1px solid rgba(37,99,235,.18);overflow:hidden;}
    .spark svg{display:block;width:100%;height:100%}

    .kpi.span-3{grid-column:span 3}
    .span-12{grid-column:span 12}
    .span-7{grid-column:span 7}
    .span-5{grid-column:span 5}
    .span-6{grid-column:span 6}

    @media (max-width:980px){
      .kpi.span-3{grid-column:span 6}
      .span-7,.span-5,.span-6{grid-column:span 12}
    }
    @media (max-width:520px){
      .kpi.span-3{grid-column:span 12}
    }

    .lists{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:980px){.lists{grid-template-columns:1fr}}
    .rank{border:1px solid rgba(219,227,239,.75);border-radius:var(--radius-sm);overflow:hidden;}
    .rank .rh{padding:12px 12px 10px;background:rgba(2,6,23,.02);border-bottom:1px solid rgba(219,227,239,.75);}
    .rank .rh strong{font-size:13px}
    .rank .rh div{margin-top:4px;font-size:12px;color:var(--muted)}
    .rank ul{margin:0;padding:0;list-style:none;}
    .rank li{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(219,227,239,.55);}
    .rank li:last-child{border-bottom:0}
    .rank .left{display:flex;gap:10px;align-items:flex-start;min-width:0;}
    .rank .num{width:24px;height:24px;border-radius:8px;display:grid;place-items:center;background:rgba(37,99,235,.10);border:1px solid rgba(37,99,235,.18);color:var(--accent-2);font-weight:800;font-size:12px;flex:0 0 auto;}
    .rank .skill{font-weight:750;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px;}
    .rank .fam{font-size:12px;color:var(--muted);margin-top:2px}
    .rank .right{text-align:right;flex:0 0 auto;}
    .rank .metric{font-weight:800;font-size:13px;}
    .rank .note{font-size:12px;color:var(--muted);margin-top:2px}

    .heat-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:920px;}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(219,227,239,.7);font-size:12px;vertical-align:middle;background:var(--surface);}
    th{position:sticky;top:0;z-index:2;background:#f9fbff;color:#0b1220;font-size:12px;font-weight:800;border-bottom:1px solid rgba(219,227,239,.95);text-align:left;white-space:nowrap;}
    td:first-child,th:first-child{position:sticky;left:0;z-index:1;background:#fff;}
    .cell{cursor:pointer;border-radius:12px;border:1px solid rgba(219,227,239,.85);padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px;user-select:none;min-width:140px;}
    .lvl{font-weight:850;font-size:12px;}
    .lvl0{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.22)}
    .lvl1{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.24)}
    .lvl2{background:rgba(37,99,235,.10);border-color:rgba(37,99,235,.22)}
    .lvl3{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.22)}
    .muted{color:var(--muted)}
    .chart-box{height:260px}

    .drawer{position:fixed;right:14px;top:82px;width:min(420px,calc(100vw - 28px));max-height:calc(100vh - 96px);overflow:auto;border-radius:18px;border:1px solid rgba(219,227,239,.95);background:rgba(255,255,255,.92);backdrop-filter:blur(10px);box-shadow:var(--shadow);display:none;z-index:100;}
    .drawer.open{display:block}
    .drawer .dh{padding:14px 14px 10px;border-bottom:1px solid rgba(219,227,239,.75);display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .drawer h3{margin:0;font-size:14px;letter-spacing:-.01em;}
    .drawer .close{border:1px solid rgba(219,227,239,.95);background:#fff;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:800;color:var(--muted);}
    .drawer .db{padding:12px 14px 14px}
    .drawer .section{margin:0 0 12px}
    .drawer .section strong{font-size:12px}
    .drawer .section p,.drawer .section ul{margin:6px 0 0;font-size:12px;color:var(--muted);}
    .drawer ul{padding-left:18px}

    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    @media (max-width:980px){.actions{grid-template-columns:1fr}}
    .action{border:1px solid rgba(219,227,239,.75);border-radius:var(--radius-sm);padding:12px;background:rgba(2,6,23,.015);}
    .action .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(219,227,239,.85);background:#fff;font-size:12px;font-weight:800;color:var(--muted);margin-bottom:8px;}
    .action h4{margin:0 0 6px;font-size:13px}
    .action p{margin:0;font-size:12px;color:var(--muted)}
    .footnote{margin-top:10px;font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:11px;border:1px solid rgba(219,227,239,.9);background:#fff;padding:2px 6px;border-radius:8px;color:#0b1220;white-space:nowrap;}
    .debug{
      border:1px dashed rgba(37,99,235,.35);
      background: rgba(37,99,235,.05);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .debug strong{color:#0b1220}
    .debug button{
      border:1px solid rgba(37,99,235,.25);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:#0b1220;
    }
    .debug pre{
      margin:8px 0 0;
      padding:10px;
      background:#fff;
      border:1px solid rgba(219,227,239,.9);
      border-radius:12px;
      overflow:auto;
      max-width:100%;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div>
          <div class="badge"><span class="dot"></span><strong>Executive Dashboard - Presented at AI Panel Discussion</strong> · AI Skillsets for Hiring Now</div>
          <h1 class="title">NKU — AI Skillset Needs for Graduates Getting Hired Today</h1>
          <p class="subtitle">Top skills now · fastest-rising skills · NKU coverage gaps · opportunities board</p>
          <button type="button" class="sources-btn" id="openSources">Data sources</button>
        </div>

        <div class="toolbar">
          <div class="pillset" role="group" aria-label="Audience Toggle" id="audienceToggle">
            <button type="button" data-audience="all" aria-pressed="true">All NKU Grads</button>
            <button type="button" data-audience="business" aria-pressed="false">Business</button>
            <button type="button" data-audience="informatics" aria-pressed="false">Informatics</button>
            <button type="button" data-audience="health" aria-pressed="false">Health</button>
          </div>
          <div class="meta">
            <span><span class="dot"></span> Last refresh: <strong id="lastRefresh">—</strong></span>
            <span><strong>Sources:</strong> USAJOBS + Adzuna (via Cloudflare Worker)</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="wrap">
      <div class="debug">
        <div>
          <div><strong>Debug</strong>: If counts are 0, the Worker is returning empty results (usually query param mismatch).</div>
          <div>AI jobs: <strong id="dbgAi">—</strong> · Baseline jobs: <strong id="dbgBase">—</strong></div>
          <pre id="dbgSample">Loading…</pre>
        </div>
        <div>
          <button id="forceRefresh">Force refresh (clear cache)</button>
        </div>
      </div>

      <section class="grid kpis" aria-label="Key performance indicators" style="margin-top:14px">
        <div class="card kpi span-3">
          <div class="kpi-top">
            <div>
              <div class="kpi-label">AI-skill job share</div>
              <div class="kpi-value" id="kpi-aiShare">—</div>
            </div>
            <div class="kpi-delta up" id="kpi-aiShareDelta">▲ live</div>
          </div>
          <div class="muted" style="font-size:12px">AI postings ÷ (AI + baseline postings)</div>
          <div class="spark"><svg viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline id="spark-aiShare" fill="none" stroke="rgba(37,99,235,.8)" stroke-width="2" points=""></polyline>
          </svg></div>
        </div>

        <div class="card kpi span-3">
          <div class="kpi-top">
            <div>
              <div class="kpi-label">Fastest-growing skill family</div>
              <div class="kpi-value" id="kpi-fastFamily">—</div>
            </div>
            <div class="kpi-delta up" id="kpi-fastFamilyDelta">▲ live</div>
          </div>
          <div class="muted" style="font-size:12px">Heuristic from current postings text</div>
          <div class="spark"><svg viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline id="spark-fastFamily" fill="none" stroke="rgba(37,99,235,.8)" stroke-width="2" points=""></polyline>
          </svg></div>
        </div>

        <div class="card kpi span-3">
          <div class="kpi-top">
            <div>
              <div class="kpi-label">Non-CS share of AI demand</div>
              <div class="kpi-value" id="kpi-noncsShare">—</div>
            </div>
            <div class="kpi-delta up" id="kpi-noncsDelta">▲ live</div>
          </div>
          <div class="muted" style="font-size:12px">Heuristic from job titles</div>
          <div class="spark"><svg viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline id="spark-noncs" fill="none" stroke="rgba(37,99,235,.8)" stroke-width="2" points=""></polyline>
          </svg></div>
        </div>

        <div class="card kpi span-3">
          <div class="kpi-top">
            <div>
              <div class="kpi-label">Estimated wage premium</div>
              <div class="kpi-value" id="kpi-wagePremium">—</div>
            </div>
            <div class="kpi-delta up" id="kpi-wageDelta">▲ n/a</div>
          </div>
          <div class="muted" style="font-size:12px">Not exposed by USAJOBS/Adzuna APIs</div>
          <div class="spark"><svg viewBox="0 0 120 36" preserveAspectRatio="none">
            <polyline id="spark-wage" fill="none" stroke="rgba(37,99,235,.8)" stroke-width="2" points=""></polyline>
          </svg></div>
        </div>
      </section>

      <section class="grid" style="margin-top:14px">
        <div class="card span-12">
          <div class="hd">
            <div>
              <h2>Top Skills Now vs. Fastest Rising</h2>
              <p>Automatically extracted from USAJOBS + Adzuna posting text (titles/descriptions).</p>
            </div>
            <div class="meta">
              <span class="chip">Now: <strong>Current sample</strong> · Rising: <strong>Heuristic</strong></span>
            </div>
          </div>
          <div class="bd">
            <div class="lists">
              <div class="rank">
                <div class="rh"><strong>Top AI Skills in Postings</strong><div>Ranked by frequency in fetched postings</div></div>
                <ul id="listNow"></ul>
              </div>
              <div class="rank">
                <div class="rh"><strong>Fastest Rising Skills</strong><div>Heuristic signal</div></div>
                <ul id="listRising"></ul>
              </div>
            </div>
            <div class="footnote">
              <span class="chip">Tip: Click a heatmap cell below to open the drilldown panel.</span>
              <span class="chip">Keyboard: <span class="kbd">Esc</span> closes drilldown</span>
            </div>
          </div>
        </div>
      </section>

      <section class="grid" style="margin-top:14px">
        <div class="card span-7">
          <div class="hd">
            <div>
              <h2>NKU Coverage Gap Matrix</h2>
              <p>Rows = skill families · Columns = programs/courses · Cells = coverage level (0–3).</p>
            </div>
            <div class="meta">
              <span class="chip">0 None · 1 Mentioned · 2 Practiced · 3 Assessed</span>
              <span class="chip">Rightmost = Market Demand Index</span>
            </div>
          </div>
          <div class="bd heat-wrap"><table id="heatTable"></table></div>
        </div>

        <div class="card span-5">
          <div class="hd">
            <div>
              <h2>Where the Jobs Are</h2>
              <p>Top categories from blended postings.</p>
            </div>
            <div class="meta"><span class="chip" id="segLabel">Top categories</span></div>
          </div>
          <div class="bd">
            <div class="chart-box"><canvas id="segChart"></canvas></div>
            <p class="muted" id="segSourceNote" style="margin:10px 0 0; font-size:12px">Sources: USAJOBS + Adzuna</p>
          </div>
        </div>
      </section>

      <section class="grid" style="margin-top:14px">
        <div class="card span-6">
          <div class="hd">
            <div><h2>Trust & Governance Skills (Credibility Boost)</h2><p>Employable + trustworthy AI capability.</p></div>
            <div class="meta"><span class="chip">Responsible AI · Risk · Privacy · Security</span></div>
          </div>
          <div class="bd">
            <ul class="muted" style="margin:0; padding-left:18px; font-size:12px">
              <li><strong>Responsible AI</strong>: fairness, transparency, human oversight</li>
              <li><strong>AI risk management</strong>: evaluation, monitoring, documentation</li>
              <li><strong>Security & privacy</strong>: data handling, access control, policy</li>
              <li><strong>Governance</strong>: acceptable use, model selection, vendor risk</li>
            </ul>
          </div>
        </div>

        <div class="card span-6">
          <div class="hd">
            <div><h2>Opportunities Board</h2><p>Turn insight into decisions (owners + timelines).</p></div>
            <div class="meta"><span class="chip">Quick wins</span></div>
          </div>
          <div class="bd"><div class="actions" id="actions"></div></div>
        </div>
      </section>
    </div>
  </main>

  <aside class="drawer" id="drawer" role="dialog" aria-modal="false">
    <div class="dh">
      <div>
        <h3 id="drawerTitle">Skill Drilldown</h3>
        <div class="muted" style="font-size:12px" id="drawerSubtitle">Click a heatmap cell to populate details.</div>
      </div>
      <button class="close" type="button" id="drawerClose">Close</button>
    </div>
    <div class="db" id="drawerBody"></div>
  </aside>

  <script>
    const PROXY_BASE = "https://ai-skills-proxy.nealb3.workers.dev";

    const AI_QUERY = "artificial intelligence OR machine learning OR LLM OR GenAI OR ChatGPT OR Copilot";
    const BASELINE_QUERY = "software OR analyst OR manager";

    const CACHE_KEY = "nku_ai_jobs_blend_cache_v2";
    const CACHE_TTL_MS = 60 * 60 * 1000;

    // ---------- Static pieces ----------
    const dashboardData = {
      lastRefresh: "—",
      audiences: ["all","business","informatics","health"],
      kpis: { all: {} },
      topNow: { all: [] },
      rising: { all: [] },
      segmentation: { all: { label:"Top categories", labels:[], values:[] } },
      sources: {
        primary: [
          { name:"USAJOBS Search API", use:"Federal postings anchor source", notes:"Queried via Worker with required headers." },
          { name:"Adzuna Jobs API", use:"Private-sector coverage", notes:"Queried via Worker (keys hidden from browser)." }
        ],
        definitions: [
          { term:"AI-skill job share", definition:"AI postings ÷ (AI + baseline postings) for this sample window." },
          { term:"Top skills", definition:"Keyword frequency in titles/descriptions across blended postings." },
          { term:"Non-CS share", definition:"Heuristic from job titles (non-engineering vs engineering words)." }
        ],
        refreshCadence:"Live on page load (cached in browser for 1 hour)."
      },
      coverage: {
        columns: ["INF 125 (AI Literacy)", "INF 120 (Python)", "INF 286 (Web)", "IS/BA Analytics", "Gen-Ed / Core"],
        rows: [
          { family:"GenAI tools & workflows", demandIndex:92, cells:[2,1,1,2,2],
            drill:{ roles:["Business Analyst","Marketing Analyst","Operations Specialist","Junior Developer"],
              keywords:["prompting","workflow automation","copilot","chatgpt","ai assistant"],
              quickWins:["Add a 1-week lab: ‘Design a repeatable AI workflow’.","Require a citation + verification checklist.","Assess with a rubric (clarity, safety, iteration)."]}},
          { family:"Data foundations (SQL / BI)", demandIndex:88, cells:[1,2,1,3,1],
            drill:{ roles:["Data Analyst","Operations Analyst","Finance Analyst"],
              keywords:["sql","dashboard","power bi","tableau","data literacy"],
              quickWins:["Embed a data-to-decision mini-project.","Add a dashboard critique assignment."]}},
          { family:"Automation (Python / scripting)", demandIndex:79, cells:[1,3,1,2,0],
            drill:{ roles:["Junior Developer","Automation Analyst","Systems Analyst"],
              keywords:["python","automation","scripting","api","etl"],
              quickWins:["Add small automation labs tied to real tasks.","Introduce build-once, reuse mindset."]}},
          { family:"Governance (evaluation, policy, ethics)", demandIndex:74, cells:[3,1,0,1,2],
            drill:{ roles:["Compliance Analyst","Risk Analyst","Project Manager"],
              keywords:["responsible ai","evaluation","risk","policy","governance"],
              quickWins:["Add a 30-min AI risk module + rubric.","Require documentation: tool used, data sensitivity, limitations."]}},
          { family:"Human skills (communication, change mgmt)", demandIndex:69, cells:[2,1,1,2,3],
            drill:{ roles:["Project Coordinator","Business Analyst","Customer Success"],
              keywords:["stakeholder","communication","change management","presentation"],
              quickWins:["Require exec-ready 1-pagers.","Add communicate-uncertainty micro-lesson."]}},
        ]
      },
      actionBoard: [
        { tag:"Quick win (30–60 days)", title:"Embed AI workflow labs + rubric", desc:"Add repeatable AI workflow assignment (inputs → prompts → checks → outputs)." },
        { tag:"Quick win (30–60 days)", title:"Standardize AI usage policy language", desc:"Student-friendly guidance: allowed use, citation, verification." },
        { tag:"1 semester", title:"Launch micro-badges by skill family", desc:"GenAI workflows, Data literacy, Automation, Governance." },
        { tag:"1 semester", title:"Partner project pilots", desc:"Align 3 employer projects to top 3 gaps (exec dashboard + demo)." },
        { tag:"12 months", title:"Program-level mapping & reporting", desc:"Living AI skills coverage map + term-by-term tracking." },
        { tag:"12 months", title:"Assessment + outcomes story", desc:"Report skills coverage, artifacts, placement, employer feedback." }
      ]
    };

    // ---------- Helpers ----------
    let currentAudience = "all";
    let segChart = null;

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function setText(sel, txt){ const el = $(sel); if(el) el.textContent = txt; }
    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function sparkPoints(values){
      if(!values || values.length < 2) return "";
      const max = Math.max(...values), min = Math.min(...values), range = (max-min)||1;
      return values.map((v,i)=>{
        const x = (i/(values.length-1))*120;
        const y = 34 - ((v-min)/range)*30;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(" ");
    }
    function pct(n){ return (n*100).toFixed(1) + "%"; }
    function coverageClass(level){ return ["lvl0","lvl1","lvl2","lvl3"][level] || "lvl0"; }
    function coverageLabel(level){ return ["None","Mentioned","Practiced","Assessed"][level] || "None"; }

    // ---------- Cache ----------
    function readCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(Date.now() - obj.time > CACHE_TTL_MS) return null;
        // IMPORTANT: if cached counts are empty, ignore cache (prevents “stuck at 0”)
        if((obj.data?.counts?.ai||0) === 0 && (obj.data?.counts?.base||0) === 0) return null;
        return obj.data;
      }catch{ return null; }
    }
    function writeCache(data){
      try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), data })); }catch{}
    }
    function clearCache(){ try{ localStorage.removeItem(CACHE_KEY); }catch{} }

    // ---------- Fetch with fallbacks ----------
    async function fetchJson(url){
      const res = await fetch(url, { cache:"no-store" });
      const text = await res.text();
      let json;
      try{ json = JSON.parse(text); }catch{
        throw new Error("Non-JSON from " + url + ": " + text.slice(0,180));
      }
      if(!res.ok){
        const msg = json?.error || json?.message || ("HTTP " + res.status);
        throw new Error(url + " → " + msg);
      }
      return json;
    }

    async function fetchFirstWorking(urls){
      let lastErr = null;
      for(const u of urls){
        try{
          const j = await fetchJson(u);
          return { url: u, json: j };
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error("All fallbacks failed");
    }

    function normalizeUSAJOBS(payload){
      const items = payload?.SearchResult?.SearchResultItems || [];
      return items.map(it=>{
        const d = it?.MatchedObjectDescriptor || {};
        const details = d?.UserArea?.Details || {};
        const cats = (d?.JobCategory || []).map(c=>c?.Name).filter(Boolean);
        return {
          source: "USAJOBS",
          title: d?.PositionTitle || "",
          description: details?.MajorDuties || details?.JobSummary || "",
          company: d?.OrganizationName || d?.DepartmentName || "Federal",
          category: cats[0] || d?.DepartmentName || "Federal",
          location: (d?.PositionLocation || [])[0]?.LocationName || "",
          url: d?.PositionURI || ""
        };
      });
    }

    function normalizeAdzuna(payload){
      const items = payload?.results || [];
      return items.map(it=>({
        source: "Adzuna",
        title: it?.title || "",
        description: it?.description || "",
        company: it?.company?.display_name || "Unknown",
        category: it?.category?.label || "Other",
        location: it?.location?.display_name || "",
        url: it?.redirect_url || it?.adref || ""
      }));
    }

    async function fetchBlended(){
      const cached = readCache();
      if(cached) return cached;

      // Fallback param styles (this is what fixes the “0 results” issue)
      const usAiUrls = [
        `${PROXY_BASE}/usajobs?keyword=${encodeURIComponent(AI_QUERY)}&ResultsPerPage=50&Page=1`,
        `${PROXY_BASE}/usajobs?Keyword=${encodeURIComponent(AI_QUERY)}&ResultsPerPage=50&Page=1`,
        `${PROXY_BASE}/usajobs?q=${encodeURIComponent(AI_QUERY)}&ResultsPerPage=50&Page=1`,
      ];
      const usBaseUrls = [
        `${PROXY_BASE}/usajobs?keyword=${encodeURIComponent(BASELINE_QUERY)}&ResultsPerPage=50&Page=1`,
        `${PROXY_BASE}/usajobs?Keyword=${encodeURIComponent(BASELINE_QUERY)}&ResultsPerPage=50&Page=1`,
        `${PROXY_BASE}/usajobs?q=${encodeURIComponent(BASELINE_QUERY)}&ResultsPerPage=50&Page=1`,
      ];

      const adAiUrls = [
        `${PROXY_BASE}/adzuna?what=${encodeURIComponent("ai OR artificial intelligence OR machine learning OR llm OR genai")}&results_per_page=50&page=1&country=us`,
        `${PROXY_BASE}/adzuna?q=${encodeURIComponent("ai OR artificial intelligence OR machine learning OR llm OR genai")}&results_per_page=50&page=1&country=us`,
        `${PROXY_BASE}/adzuna?query=${encodeURIComponent("ai OR artificial intelligence OR machine learning OR llm OR genai")}&results_per_page=50&page=1&country=us`,
      ];
      const adBaseUrls = [
        `${PROXY_BASE}/adzuna?what=${encodeURIComponent("software OR analyst OR manager")}&results_per_page=50&page=1&country=us`,
        `${PROXY_BASE}/adzuna?q=${encodeURIComponent("software OR analyst OR manager")}&results_per_page=50&page=1&country=us`,
        `${PROXY_BASE}/adzuna?query=${encodeURIComponent("software OR analyst OR manager")}&results_per_page=50&page=1&country=us`,
      ];

      const us_ai = await fetchFirstWorking(usAiUrls);
      const us_base = await fetchFirstWorking(usBaseUrls);
      const ad_ai = await fetchFirstWorking(adAiUrls);
      const ad_base = await fetchFirstWorking(adBaseUrls);

      const aiJobs = [...normalizeUSAJOBS(us_ai.json), ...normalizeAdzuna(ad_ai.json)];
      const baseJobs = [...normalizeUSAJOBS(us_base.json), ...normalizeAdzuna(ad_base.json)];

      const out = {
        fetchedAt: new Date().toISOString(),
        debugUrls: { us_ai: us_ai.url, us_base: us_base.url, ad_ai: ad_ai.url, ad_base: ad_base.url },
        aiJobs,
        baseJobs,
        counts: { ai: aiJobs.length, base: baseJobs.length }
      };

      writeCache(out);
      return out;
    }

    // ---------- Skills ----------
    const SKILLS = [
      { skill:"Prompting & workflow design", family:"GenAI workflows", keys:["prompt","prompting","workflow","automation","agent","agentic"] },
      { skill:"AI tool proficiency (Copilot/ChatGPT)", family:"GenAI tools", keys:["copilot","chatgpt","gemini","claude","assistant"] },
      { skill:"LLM application development", family:"GenAI engineering", keys:["llm","langchain","rag","retrieval","vector","embedding","prompt engineering"] },
      { skill:"Python for automation", family:"Automation", keys:["python","scripting","automation","etl"] },
      { skill:"Data literacy (SQL / dashboards)", family:"Data foundations", keys:["sql","power bi","tableau","dashboard","analytics","reporting"] },
      { skill:"Model evaluation & testing", family:"Governance", keys:["evaluation","red team","red-team","testing","benchmark","validation"] },
      { skill:"AI ethics & responsible use", family:"Governance", keys:["responsible ai","ethics","fairness","bias","governance","policy","compliance"] },
      { skill:"Security & privacy", family:"Trust", keys:["privacy","security","pii","risk","secure","infosec"] },
      { skill:"Product thinking with AI", family:"Business/PM", keys:["product","roadmap","requirements","stakeholder","strategy"] },
      { skill:"Human-centered AI", family:"Design", keys:["human-centered","ux","design","accessibility","research"] },
    ];

    function scoreSkills(jobs){
      const counts = new Map();
      for(const s of SKILLS) counts.set(s.skill, 0);
      for(const j of jobs){
        const text = (j.title + " " + j.description).toLowerCase();
        for(const s of SKILLS){
          if(s.keys.some(k => text.includes(k))) counts.set(s.skill, counts.get(s.skill) + 1);
        }
      }
      return counts;
    }
    function topFromCounts(countMap, jobsTotal, limit=8){
      return Array.from(countMap.entries())
        .map(([skill, c])=>{
          const meta = SKILLS.find(x=>x.skill===skill);
          return { skill, family: meta?.family || "Other", metric: String(c), note: `mentions (${jobsTotal} postings)` };
        })
        .sort((a,b)=> Number(b.metric)-Number(a.metric))
        .slice(0, limit);
    }
    function classifyNonCS(job){
      const t = (job.title || "").toLowerCase();
      const csWords = ["engineer","developer","data scientist","ml engineer","software","programmer","devops","architect","backend","frontend","full stack","full-stack"];
      return !csWords.some(w => t.includes(w));
    }
    function topCategories(jobs, limit=6){
      const m = new Map();
      for(const j of jobs){
        const key = (j.category || "Other").trim();
        m.set(key, (m.get(key)||0) + 1);
      }
      const arr = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0, limit);
      return { labels: arr.map(x=>x[0]), values: arr.map(x=>x[1]) };
    }

    // ---------- Render ----------
    function renderHeader(){ setText("#lastRefresh", dashboardData.lastRefresh); }

    function renderKpis(){
      const k = dashboardData.kpis.all;
      setText("#kpi-aiShare", k.aiShare?.value ?? "—");
      setText("#kpi-aiShareDelta", `▲ ${k.aiShare?.delta ?? "live"}`);
      $("#spark-aiShare").setAttribute("points", sparkPoints(k.aiShare?.trend || [1,2,3,4,5,6]));

      setText("#kpi-fastFamily", k.fastFamily?.value ?? "—");
      setText("#kpi-fastFamilyDelta", `▲ ${k.fastFamily?.delta ?? "live"}`);
      $("#spark-fastFamily").setAttribute("points", sparkPoints(k.fastFamily?.trend || [1,2,3,4,5,6]));

      setText("#kpi-noncsShare", k.noncsShare?.value ?? "—");
      setText("#kpi-noncsDelta", `▲ ${k.noncsShare?.delta ?? "live"}`);
      $("#spark-noncs").setAttribute("points", sparkPoints(k.noncsShare?.trend || [1,2,3,4,5,6]));

      setText("#kpi-wagePremium", k.wagePremium?.value ?? "—");
      setText("#kpi-wageDelta", `▲ ${k.wagePremium?.delta ?? "n/a"}`);
      $("#spark-wage").setAttribute("points", sparkPoints(k.wagePremium?.trend || [1,1,1,1,1,1]));
    }

    function renderRankLists(){
      const now = dashboardData.topNow.all || [];
      const rising = dashboardData.rising.all || [];

      const liTemplate = (item, idx) => `
        <li>
          <div class="left">
            <div class="num">${idx+1}</div>
            <div style="min-width:0">
              <div class="skill" title="${escapeHtml(item.skill)}">${escapeHtml(item.skill)}</div>
              <div class="fam">${escapeHtml(item.family)}</div>
            </div>
          </div>
          <div class="right">
            <div class="metric">${escapeHtml(item.metric)}</div>
            <div class="note">${escapeHtml(item.note)}</div>
          </div>
        </li>
      `;
      $("#listNow").innerHTML = now.map(liTemplate).join("");
      $("#listRising").innerHTML = rising.map(liTemplate).join("");
    }

    function renderHeatmap(){
      const cols = dashboardData.coverage.columns;
      const rows = dashboardData.coverage.rows;

      const thead = `
        <thead><tr>
          <th>Skill Family</th>
          ${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}
          <th>Market Demand Index</th>
        </tr></thead>
      `;

      const tbody = rows.map((r, rIdx)=>`
        <tr>
          <td><span class="chip">${escapeHtml(r.family)}</span></td>
          ${r.cells.map((lvl, cIdx)=>`
            <td>
              <div class="cell ${coverageClass(lvl)}" role="button" tabindex="0"
                data-row="${rIdx}" data-col="${cIdx}"
                aria-label="${escapeHtml(r.family)} — ${escapeHtml(cols[cIdx])}: ${coverageLabel(lvl)}">
                <span class="lvl">${coverageLabel(lvl)}</span>
                <span class="muted">${lvl}</span>
              </div>
            </td>
          `).join("")}
          <td><span class="chip">${r.demandIndex}</span></td>
        </tr>
      `).join("");

      $("#heatTable").innerHTML = thead + `<tbody>${tbody}</tbody>`;

      $$(".cell", $("#heatTable")).forEach(el=>{
        el.addEventListener("click", onHeatCellActivate);
        el.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){ e.preventDefault(); onHeatCellActivate(e); }
        });
      });
    }

    function renderSegmentation(){
      const seg = dashboardData.segmentation.all;
      setText("#segLabel", seg.label);

      const ctx = $("#segChart");
      if(!window.Chart){
        ctx.replaceWith(Object.assign(document.createElement("div"), { className:"muted", textContent:"Chart.js not available." }));
        return;
      }
      if(segChart) segChart.destroy();
      segChart = new Chart(ctx, {
        type:"bar",
        data:{ labels: seg.labels, datasets:[{ label: seg.label, data: seg.values }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
        }
      });
    }

    function renderActions(){
      $("#actions").innerHTML = dashboardData.actionBoard.map(it=>`
        <div class="action">
          <div class="tag">${escapeHtml(it.tag)}</div>
          <h4>${escapeHtml(it.title)}</h4>
          <p>${escapeHtml(it.desc)}</p>
        </div>
      `).join("");
    }

    // ---------- Drawer ----------
    function openDrawer(payload){
      $("#drawerTitle").textContent = payload.title;
      $("#drawerSubtitle").textContent = payload.subtitle;
      $("#drawerBody").innerHTML = payload.html || "";
      $("#drawer").classList.add("open");
    }
    function closeDrawer(){ $("#drawer").classList.remove("open"); }

    function onHeatCellActivate(e){
      const el = e.currentTarget;
      const rowIdx = Number(el.getAttribute("data-row"));
      const colIdx = Number(el.getAttribute("data-col"));
      const row = dashboardData.coverage.rows[rowIdx];
      const colName = dashboardData.coverage.columns[colIdx];
      const lvl = row.cells[colIdx];

      openDrawer({
        title: `${row.family} — ${colName}`,
        subtitle: `Coverage: ${coverageLabel(lvl)} (${lvl}) · Market Demand Index: ${row.demandIndex}`,
        html: `
          <div class="section"><strong>Target roles</strong>
            <ul>${row.drill.roles.map(r=>`<li>${escapeHtml(r)}</li>`).join("")}</ul>
          </div>
          <div class="section"><strong>Posting keywords</strong>
            <p>${row.drill.keywords.map(k=>`<span class="chip" style="margin:3px 6px 0 0">${escapeHtml(k)}</span>`).join("")}</p>
          </div>
          <div class="section"><strong>Curriculum “quick wins”</strong>
            <ul>${row.drill.quickWins.map(w=>`<li>${escapeHtml(w)}</li>`).join("")}</ul>
          </div>
        `
      });
    }

    $("#openSources").addEventListener("click", ()=>{
      const s = dashboardData.sources;
      openDrawer({
        title: "Data Sources & Definitions",
        subtitle: `Last refresh: ${dashboardData.lastRefresh}`,
        html: `
          <div class="section"><strong>Primary sources</strong>
            <ul>${s.primary.map(x=>`<li><strong>${escapeHtml(x.name)}</strong> — ${escapeHtml(x.use)}<br><span class="muted">${escapeHtml(x.notes||"")}</span></li>`).join("")}</ul>
          </div>
          <div class="section"><strong>Definitions</strong>
            <ul>${s.definitions.map(d=>`<li><strong>${escapeHtml(d.term)}:</strong> ${escapeHtml(d.definition)}</li>`).join("")}</ul>
          </div>
          <div class="section"><strong>Refresh cadence</strong><p>${escapeHtml(s.refreshCadence)}</p></div>
        `
      });
    });

    $("#drawerClose").addEventListener("click", closeDrawer);
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeDrawer(); });

    // ---------- Live model build ----------
    function buildLiveModel(blended){
      const aiJobs = blended.aiJobs || [];
      const baseJobs = blended.baseJobs || [];

      // Debug panel
      setText("#dbgAi", String(aiJobs.length));
      setText("#dbgBase", String(baseJobs.length));

      const sample = {
        counts: blended.counts,
        debugUrls: blended.debugUrls,
        aiSampleTitles: aiJobs.slice(0,5).map(j=>`${j.source}: ${j.title}`),
        baseSampleTitles: baseJobs.slice(0,3).map(j=>`${j.source}: ${j.title}`)
      };
      $("#dbgSample").textContent = JSON.stringify(sample, null, 2);

      const share = (aiJobs.length) / Math.max(aiJobs.length + baseJobs.length, 1);
      const noncsShare = aiJobs.length ? (aiJobs.filter(classifyNonCS).length / aiJobs.length) : 0;

      const counts = scoreSkills(aiJobs);
      const topNow = topFromCounts(counts, aiJobs.length, 8);

      // rising heuristic (recent vs older slice)
      const mid = Math.floor(aiJobs.length / 2) || 1;
      const recent = aiJobs.slice(0, mid);
      const older = aiJobs.slice(mid);
      const cRecent = scoreSkills(recent);
      const cOlder = scoreSkills(older);

      const risingArr = Array.from(cRecent.entries()).map(([skill, c1])=>{
        const c0 = cOlder.get(skill) || 0;
        const growth = c1 - c0;
        const meta = SKILLS.find(x=>x.skill===skill);
        return { skill, family: meta?.family || "Other", metric: (growth>=0?"+":"") + String(growth), note:"recent vs older slice" };
      }).sort((a,b)=> Number(b.metric)-Number(a.metric)).slice(0,8);

      const fastFamily = (risingArr[0]?.family) || (topNow[0]?.family) || "—";

      const seg = topCategories(aiJobs, 6);

      dashboardData.lastRefresh = new Date(blended.fetchedAt).toLocaleString();
      dashboardData.kpis.all = {
        aiShare: { value: pct(share), delta: "live", trend: [10,12,13,14,15,16,17,18,18,19,20, Math.round(share*100)] },
        fastFamily: { value: fastFamily, delta: "live", trend: [12,14,16,18,22,24,26,28,30,32,34,36] },
        noncsShare: { value: pct(noncsShare), delta: "live", trend: [50,52,53,54,55,56,57,58,59,60,61, Math.round(noncsShare*100)] },
        wagePremium: { value: "—", delta: "n/a", trend: [10,10,10,10,10,10,10,10,10,10,10,10] }
      };
      dashboardData.topNow.all = topNow;
      dashboardData.rising.all = risingArr;
      dashboardData.segmentation.all = { label:"Top categories", labels: seg.labels, values: seg.values };
    }

    // ---------- Init ----------
    async function init(){
      renderHeatmap();
      renderActions();

      $$("#audienceToggle button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          currentAudience = btn.dataset.audience;
          $$("#audienceToggle button").forEach(b=>b.setAttribute("aria-pressed", b===btn ? "true" : "false"));
          // data is global in this version; re-render anyway for consistency
          renderKpis(); renderRankLists(); renderSegmentation(); renderHeader();
        });
      });

      $("#forceRefresh").addEventListener("click", ()=>{
        clearCache();
        location.reload();
      });

      try{
        const blended = await fetchBlended();
        buildLiveModel(blended);
        renderHeader();
        renderKpis();
        renderRankLists();
        renderSegmentation();
        setText("#segSourceNote", `Sources: USAJOBS + Adzuna via ${PROXY_BASE} (cached 1h)`);
      }catch(err){
        console.error(err);
        setText("#lastRefresh","Fetch failed");
        setText("#dbgSample", "Fetch failed. Open DevTools → Console for details.\n\n" + String(err));
        setText("#kpi-aiShare","Error");
        setText("#kpi-fastFamily","Check debug");
        setText("#kpi-noncsShare","Check debug");
      }
    }

    init();
  </script>
</body>
</html>
